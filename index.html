<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Object Detection</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
<body>
    <div id="waiting">Waiting for the model...</div>
    <div id="mainFrame">
        <div id="camLiveDiv">
            <video id="mainVideo" autoplay width="100%" height="100%"></video>
        </div>
    </div>

    <!-- Load TensorFlow.js. This is required to use coco-ssd model. -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"> </script>
    <!-- Load the coco-ssd model. -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"> </script>

    <script>
        const mainVideo = document.getElementById("mainVideo");
        const waiting = document.getElementById("waiting");
        const mainDivCam = document.getElementById("camLiveDiv");


        var model = undefined;

        var labels = [];
        var boxes = [];

        function predictWebCam() {
            model.detect(mainVideo).then(predictions => {
                console.log(predictions)
                for (let i = 0; i < labels.length; i++) {
                    mainDivCam.removeChild(labels[i]);
                }
                labels = [];
                for (let i = 0; i < boxes.length; i++) {
                    mainDivCam.removeChild(boxes[i]);
                }
                boxes = [];
                for (let i = 0; i < predictions.length; i++) {
                    if (predictions[i].score > 0.55) {
                        let newBox = document.createElement("div");
                        newBox.textContent = predictions[i].class;
                        newBox.style = `
                        left: ${predictions[i].bbox[0]+30}px;
                        top: ${predictions[i].bbox[1]+30}px; 
                        width: ${predictions[i].bbox[2]}px;
                        height: ${predictions[i].bbox[3]}px;
                        `
                        newBox.classList.add("box");
                        mainDivCam.appendChild(newBox);
                        boxes.push(newBox);


                        let lab = document.createElement("div");
                        lab.textContent = predictions[i].class;
                        lab.style = `
                        left: ${predictions[i].bbox[0]+30}px;
                        top: ${predictions[i].bbox[1]+30}px; 
                        width: ${predictions[i].bbox[2]}px;
                        `
                        lab.classList.add("label");
                        mainDivCam.appendChild(lab);
                        labels.push(lab);
                    }
                }
            });
            window.requestAnimationFrame(predictWebCam);
        }

        cocoSsd.load().then(loadedModel => {
            model = loadedModel;
            mainVideo.style.display = "block";
            waiting.style.display = "none";
            if (navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
                    mainVideo.srcObject = stream;
                    mainVideo.addEventListener("loadeddata", predictWebCam)
                }).catch(err => {
                    console.log(err);
                });
            }
            else {
                console.log("Video not supported!");
            }
        })



    </script>
</body>
</html>